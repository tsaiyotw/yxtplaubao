<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‹å‹™å ±é…¬å–®å°å·¥å…·</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #0984e3;
            --bg-gray: #dfe6e9;
            --white: #ffffff;
            --border: #b2bec3;
            --danger: #e74c3c;
        }
        body {
            font-family: "Microsoft JhengHei", "PMingLiU", sans-serif;
            background-color: var(--bg-gray);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        /* --- 1. å°èˆªé ç±¤ --- */
        .nav-tabs {
            background: linear-gradient(to bottom, #34495e, #2c3e50);
            display: flex;
            padding: 0 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            flex-shrink: 0;
            border-bottom: 1px solid #1a252f;
        }
        .nav-item {
            padding: 12px 25px;
            color: #bdc3c7;
            cursor: pointer;
            font-weight: bold;
            font-size: 15px;
            margin-right: 2px;
            border-radius: 5px 5px 0 0;
            background: rgba(0,0,0,0.2);
            transition: 0.2s;
            position: relative;
            top: 2px;
        }
        .nav-item:hover { background: rgba(255,255,255,0.1); color: white; }
        .nav-item.active {
            color: #2c3e50;
            background: var(--bg-gray);
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
        }

        /* --- 2. ä¸»å…§å®¹å€ --- */
        .tab-content {
            flex: 1;
            overflow: hidden;
            position: relative;
            padding: 20px;
        }
        .tab-pane {
            display: none;
            height: 100%;
            overflow-y: auto;
            padding-bottom: 50px;
        }
        .tab-pane.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- Tab 1: å¡«å¯«è¡¨å–® --- */
        .form-container {
            max-width: 850px;
            margin: 0 auto;
            background: var(--white);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        fieldset { border: 1px solid #ccc; border-radius: 6px; padding: 20px; margin-bottom: 20px; background: #fff; }
        legend { font-weight: bold; color: var(--primary); padding: 0 10px; font-size: 1.1em; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; }
        
        .form-group { margin-bottom: 15px; }
        .label-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }
        .form-label { font-weight: bold; color: #555; }
        
        .form-input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; box-sizing: border-box; }
        .form-input:focus { border-color: var(--accent); outline: none; background: #f0f8ff; }

        /* ä¸Šå‚³æ¡†æ¨£å¼ */
        .file-box {
            border: 2px dashed #ccc;
            border-radius: 4px;
            padding: 10px;
            text-align: center;
            background: #fafafa;
            cursor: pointer;
            transition: 0.2s;
            color: #888;
            font-size: 14px;
            position: relative;
        }
        .file-box:hover { border-color: var(--accent); background: #eef6fc; color: var(--accent); }
        
        /* æ¸…é™¤æŒ‰éˆ• (å°é¡†) */
        .btn-clear-sm {
            background: var(--danger);
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            display: flex; align-items: center; gap: 4px;
        }
        .btn-clear-sm:hover { opacity: 0.8; }

        .btn-group { display: flex; gap: 15px; margin-top: 30px; }
        .btn { flex: 1; padding: 15px; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; color: white; transition: 0.2s; }
        .btn-save { background: #27ae60; }
        .btn-clear { background: #7f8c8d; }
        .btn-preview { background: var(--accent); }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); }

        .config-box { background: #fdfefe; border-color: #b2bec3; }
        
        /* ç‹€æ…‹åˆ‡æ› */
        .toggle-switch { display: flex; border: 1px solid #ccc; border-radius: 4px; overflow: hidden; }
        .toggle-opt { flex: 1; padding: 10px; text-align: center; cursor: pointer; background: #eee; }
        .toggle-opt.active { background: var(--accent); color: white; font-weight: bold; }

        /* --- Tab 2: é è¦½èˆ‡åˆ—å° --- */
        .preview-wrapper { display: flex; flex-direction: column; align-items: center; }
        .print-bar {
            background: #fff; width: 100%; max-width: 210mm; padding: 15px;
            text-align: center; border-radius: 8px; margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex; justify-content: space-between; align-items: center;
        }
        .btn-print-lg {
            background: #e67e22; color: white; border: none; padding: 10px 30px; 
            font-size: 16px; font-weight: bold; border-radius: 50px; cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* A4 ç´™å¼µ */
        .a4-page {
            width: 210mm; min-height: 297mm; background: white; padding: 15mm 20mm;
            box-shadow: 0 0 15px rgba(0,0,0,0.2); box-sizing: border-box;
            position: relative; margin-bottom: 30px;
        }

        .header { text-align: center; margin-bottom: 20px; }
        .company-title { font-size: 24pt; font-weight: bold; letter-spacing: 2px; margin-bottom: 10px; }
        .doc-title { font-size: 18pt; font-weight: bold; border: 2px solid #000; display: inline-block; padding: 5px 20px; }

        table.std-table { width: 100%; border-collapse: collapse; border: 2px solid #000; table-layout: fixed; }
        table.std-table td { border: 1px solid #000; padding: 8px 10px; vertical-align: middle; font-size: 11pt; line-height: 1.4; }
        .col-gray { background: #e0e0e0; text-align: center; font-weight: bold; }
        .money-cell { font-family: "Courier New", monospace; font-weight: bold; text-align: right; padding-right: 15px; font-size: 12pt; }
        .calc-formula { font-size: 10pt; color: #555; font-family: "Courier New", monospace; margin-left: 10px; }

        .footer-notes { font-size: 10pt; margin-top: 15px; line-height: 1.6; color: #333; }
        .signature-row { margin-top: 40px; display: flex; justify-content: space-between; border: 2px solid #000; padding: 15px; }
        .sig-box { width: 45%; }
        
        /* åœ–ç‰‡é»è²¼å€ */
        .id-paste-area { margin-top: 20px; display: flex; gap: 20px; height: 220px; }
        .paste-box { 
            flex: 1; border: 2px dashed #b2bec3; 
            display: flex; align-items: center; justify-content: center; 
            color: #b2bec3; font-size: 14pt; text-align: center; background: #fafafa;
            overflow: hidden; position: relative; cursor: pointer;
        }
        .paste-box:hover { background: #f0f0f0; border-color: #999; }
        .paste-box img { max-width: 98%; max-height: 98%; object-fit: contain; display: none; }
        .paste-text { position: absolute; pointer-events: none; }

        /* ç¬¬äºŒé  */
        .page-break { page-break-before: always; }
        .bankbook-page { display: none; border: 2px dashed #b2bec3; height: 400px; margin-top: 50px; align-items: center; justify-content: center; color: #b2bec3; font-size: 16pt; background: #fafafa; }

        /* --- Tab 3: æ­·å²ç´€éŒ„ --- */
        .history-container { max-width: 1000px; margin: 0 auto; background: white; border-radius: 8px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .history-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .history-table th, .history-table td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        .history-table th { background: #f8f9fa; color: #555; }
        .history-table tr:hover { background: #f1f2f6; }
        .btn-sm { padding: 5px 12px; font-size: 13px; border-radius: 4px; border: none; cursor: pointer; color: white; margin-right: 5px; }
        .btn-load { background: #0984e3; }
        .btn-del { background: #d63031; }

        /* --- åˆ—å°æ¨¡å¼ --- */
        @media print {
            .nav-tabs, .form-container, .print-bar, .history-container, .btn-group, .config-box { display: none !important; }
            body, .tab-content, .tab-pane { background: white !important; margin: 0 !important; padding: 0 !important; height: auto !important; overflow: visible !important; display: block !important; }
            #tab-preview { display: block !important; }
            #tab-edit, #tab-history { display: none !important; }
            .preview-wrapper { display: block !important; padding: 0 !important; margin: 0 !important; }
            .a4-page { box-shadow: none !important; margin: 0 !important; width: 100% !important; page-break-after: always; }
            .bankbook-page { display: flex !important; margin-top: 0 !important; border: none !important; border-top: 2px dashed #ccc !important; page-break-inside: avoid; }
            @page { margin: 0; size: A4; }
        }
    </style>
</head>
<body>

<div class="nav-tabs">
    <div class="nav-item active" onclick="switchTab('edit')">âœï¸ å¡«å¯«èˆ‡è¨­å®š</div>
    <div class="nav-item" onclick="switchTab('preview')">ğŸ“„ é è¦½èˆ‡åˆ—å°</div>
    <div class="nav-item" onclick="switchTab('history')">ğŸ“‚ æ­·å²ç´€éŒ„</div>
</div>

<div class="tab-content">
    
    <div id="tab-edit" class="tab-pane active">
        <div class="form-container">
            <h2 style="text-align:center; color:#2c3e50; margin-bottom:20px;">å‹å‹™å ±é…¬å–®å°å·¥å…·</h2>
            
            <fieldset class="config-box">
                <legend>âš™ï¸ åƒæ•¸è¨­å®š (è‡ªå‹•è¨˜æ†¶)</legend>
                <div class="grid-3">
                    <div class="form-group">
                        <label class="form-label">é©ç”¨å¹´åº¦</label>
                        <input type="text" id="cfg_year" class="form-input" value="115" onchange="saveConfig(); refreshPreview()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">å…¬å¸æŠ¬é ­</label>
                        <input type="text" id="cfg_company" class="form-input" value="æ‚¨çš„å…¬å¸åç¨±" onchange="saveConfig(); refreshPreview()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">åŸºæœ¬å·¥è³‡ (å…ƒ)</label>
                        <input type="text" id="cfg_minWage" class="form-input" value="29,500" 
                               onfocus="unfmtField(this)" onblur="fmtField(this); saveConfig(); refreshPreview()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">è–ªè³‡èµ·æ‰£é» (å…ƒ)</label>
                        <input type="text" id="cfg_taxThresh" class="form-input" value="90,501" 
                               onfocus="unfmtField(this)" onblur="fmtField(this); saveConfig(); refreshPreview()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">å¥ä¿è²»ç‡ (%)</label>
                        <input type="number" id="cfg_nhiRate" class="form-input" value="2.11" step="0.01" onchange="saveConfig(); refreshPreview()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ‰£ç¹³ç¨…ç‡ (%)</label>
                        <input type="number" id="cfg_taxRate" class="form-input" value="5" step="0.1" onchange="saveConfig(); refreshPreview()">
                    </div>
                </div>
            </fieldset>

            <fieldset>
                <legend>1. ç¨…å‹™èˆ‡èº«åˆ†</legend>
                <div class="grid-2">
                    <div class="form-group">
                        <label class="form-label">ç¨…å‹™èº«åˆ†</label>
                        <div class="toggle-switch">
                            <div id="btn_res" class="toggle-opt active" onclick="setResidency(true)">å±…ä½è€…</div>
                            <div id="btn_non" class="toggle-opt" onclick="setResidency(false)">éå±…ä½è€…</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">å·¥æœƒæŠ•ä¿</label>
                        <div style="padding:10px; background:#f9ca24; border-radius:4px; cursor:pointer;" onclick="toggleUnionCheck()">
                            <input type="checkbox" id="chk_union" onchange="refreshPreview()" style="transform:scale(1.5); margin-right:10px;">
                            <span style="font-weight:bold; color:#d35400;">å…·å‚™è·æ¥­å·¥æœƒèº«åˆ†</span>
                        </div>
                    </div>
                </div>
            </fieldset>

            <fieldset>
                <legend>2. å ±å–®å…§å®¹</legend>
                <div class="grid-2">
                    <div class="form-group">
                        <label class="form-label">çµ¦ä»˜æ—¥æœŸ</label>
                        <input type="date" id="in_date" class="form-input" onchange="refreshPreview()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">æ‰€å¾—é¡åˆ¥</label>
                        <select id="in_type" class="form-input" onchange="refreshPreview()">
                            <option value="50">50 - è–ªè³‡æ‰€å¾—</option>
                            <option value="9A">9A - åŸ·è¡Œæ¥­å‹™</option>
                            <option value="9B">9B - ç¨¿è²»/æ¼”è¬›</option>
                        </select>
                    </div>
                </div>
                
                <div class="grid-2">
                    <div class="form-group">
                        <label class="form-label">æ‰€å¾—äººå§“å</label>
                        <input type="text" id="in_name" class="form-input" placeholder="è«‹è¼¸å…¥å§“å" oninput="refreshPreview()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">èº«åˆ†è­‰å­—è™Ÿ</label>
                        <input type="text" id="in_id" class="form-input" oninput="refreshPreview()">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">åˆä½œå…§å®¹èªªæ˜</label>
                    <input type="text" id="in_content" class="form-input" placeholder="ä¾‹å¦‚ï¼š1æœˆä»½é¡§å•è²»..." oninput="refreshPreview()">
                </div>

                <div class="form-group">
                    <label class="form-label" style="color:#0984e3; font-size:1.1em;">çµ¦ä»˜ç¸½é¡ (æ–°å°å¹£)</label>
                    <input type="number" id="in_total" class="form-input" style="font-size:20px; font-weight:bold; border:2px solid #0984e3;" placeholder="è¼¸å…¥é‡‘é¡" oninput="refreshPreview()">
                </div>
            </fieldset>
            
            <fieldset>
                <legend>3. èº«åˆ†è­‰åœ–æª” (è‡ªå‹•åŠ æµ®æ°´å°)</legend>
                <div style="font-size:13px; color:#e74c3c; margin-bottom:10px;">
                    * ç³»çµ±å°‡è‡ªå‹•åœ¨ç©ºç™½è™•åŠ ä¸Šã€Œåƒ…ä¾›XXå…¬å¸...ç”³è«‹å‹å‹™å ±é…¬ä½¿ç”¨ã€ä¹‹ç™½è‰²æµ®æ°´å°ã€‚
                </div>
                <div class="grid-2">
                    <div class="form-group">
                        <div class="label-row">
                            <span class="form-label">æ­£é¢åœ–æª”</span>
                            <button class="btn-clear-sm" onclick="clearImage('img_front', 'text_front', 'file_front')">âŒ æ¸…é™¤</button>
                        </div>
                        <label class="file-box">
                            <input type="file" id="file_front" accept="image/*" style="display:none;" onchange="processImage(this, 'img_front', 'text_front', 'front')">
                            <span>ğŸ“‚ é»æ­¤é¸æ“‡æª”æ¡ˆ...</span>
                        </label>
                    </div>

                    <div class="form-group">
                        <div class="label-row">
                            <span class="form-label">åé¢åœ–æª”</span>
                            <button class="btn-clear-sm" onclick="clearImage('img_back', 'text_back', 'file_back')">âŒ æ¸…é™¤</button>
                        </div>
                        <label class="file-box">
                            <input type="file" id="file_back" accept="image/*" style="display:none;" onchange="processImage(this, 'img_back', 'text_back', 'back')">
                            <span>ğŸ“‚ é»æ­¤é¸æ“‡æª”æ¡ˆ...</span>
                        </label>
                    </div>
                </div>
            </fieldset>

            <div class="btn-group">
                <button class="btn btn-save" onclick="saveRecord()">ğŸ’¾ å­˜æª” (åƒ…æ–‡å­—)</button>
                <button class="btn btn-clear" onclick="clearForm()">â†º æ¸…ç©ºé‡å¡«</button>
                <button class="btn btn-preview" onclick="switchTab('preview')">ğŸ‘‰ å‰å¾€é è¦½é é¢</button>
            </div>
        </div>
    </div>

    <div id="tab-preview" class="tab-pane">
        <div class="preview-wrapper">
            <div class="print-bar">
                <span style="font-weight:bold; color:#2c3e50;">ç¢ºèªå…§å®¹ç„¡èª¤å¾Œï¼Œè«‹é»æ“Šå³æ–¹æŒ‰éˆ•åˆ—å° &nbsp; â¤ &nbsp;</span>
                <button class="btn-print-lg" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°å ±å–®</button>
            </div>

            <div class="a4-page">
                <div class="header">
                    <div class="company-title" id="out_company">å…¬å¸åç¨±</div>
                    <div class="doc-title">å‹ å‹™ å ± é…¬ å–®</div>
                </div>

                <table class="std-table">
                    <colgroup>
                        <col style="width: 15%;">
                        <col style="width: 35%;">
                        <col style="width: 15%;">
                        <col style="width: 35%;">
                    </colgroup>
                    
                    <tr>
                        <td class="col-gray">çµ¦ä»˜æ—¥æœŸ</td>
                        <td id="out_date"></td>
                        <td class="col-gray">æ‰€å¾—é¡åˆ¥</td>
                        <td id="out_type"></td>
                    </tr>
                    <tr>
                        <td class="col-gray">æ‰€å¾—äºº</td>
                        <td id="out_name"></td>
                        <td class="col-gray">èº«åˆ†è­‰è™Ÿ</td>
                        <td id="out_id"></td>
                    </tr>
                    <tr>
                        <td class="col-gray">ç¨…å‹™èº«åˆ†</td>
                        <td id="out_res">å±…ä½è€…</td>
                        <td class="col-gray">å·¥æœƒæŠ•ä¿</td>
                        <td id="out_union">å¦</td>
                    </tr>
                    <tr>
                        <td class="col-gray">åˆä½œå…§å®¹</td>
                        <td colspan="3" id="out_content"></td>
                    </tr>
                    
                    <tr>
                        <td class="col-gray" rowspan="4" style="text-align:center;">æ¬¾é …<br>è¨ˆç®—</td>
                        <td class="col-gray" colspan="2">é … ç›® (å«è¨ˆç®—å¼)</td>
                        <td class="col-gray">é‡‘ é¡</td>
                    </tr>
                    <tr>
                        <td style="padding-left:15px; font-weight:bold;" colspan="2">çµ¦ä»˜ç¸½é¡</td>
                        <td class="money-cell" id="out_total">0</td>
                    </tr>
                    <tr>
                        <td style="padding-left:15px; font-weight:bold;" colspan="2" id="out_tax_label">
                            ä»£æ‰£æ‰€å¾—ç¨…
                        </td>
                        <td class="money-cell" id="out_tax">0</td>
                    </tr>
                    <tr>
                        <td style="padding-left:15px; font-weight:bold;" colspan="2" id="out_nhi_label">
                            ä»£æ‰£äºŒä»£å¥ä¿è£œå……ä¿è²»
                        </td>
                        <td class="money-cell" id="out_nhi">0</td>
                    </tr>
                    <tr>
                        <td class="col-gray">å¯¦é ˜é‡‘é¡</td>
                        <td colspan="3" class="money-cell" style="font-size:16pt; color:black; padding-right:20px;" id="out_net">
                            æ–°å°å¹£ 0 å…ƒæ•´
                        </td>
                    </tr>
                </table>

                <div class="footer-notes">
                    <strong>â€» æ‰£ç¹³å‚™è¨» (ä¾ <span id="note_year">115</span> å¹´åº¦æ¨™æº–)ï¼š</strong><br>
                    1. <strong>è–ªè³‡æ‰€å¾—(50)ï¼š</strong>èµ·æ‰£é» $<span id="note_tax_thresh"></span>ï¼Œæ‰£ç¹³ <span id="note_tax_rate"></span>%ï¼›çµ¦ä»˜é”åŸºæœ¬å·¥è³‡($<span id="note_min_wage"></span>)ä¸”ç„¡å·¥æœƒè€…æ‰£ <span id="note_nhi_rate"></span>% å¥ä¿ã€‚<br>
                    2. <strong>åŸ·è¡Œæ¥­å‹™(9A/9B)ï¼š</strong>å–®æ¬¡çµ¦ä»˜é” $20,000 è€…ï¼Œéœ€æ‰£ç¹³ 10% æ‰€å¾—ç¨…ï¼›ç„¡å·¥æœƒè€…éœ€å¦æ‰£ <span id="note_nhi_rate_2"></span>% å¥ä¿ã€‚<br>
                    3. <strong>éå±…ä½è€…ï¼š</strong>ä¾ç¨…æ³•è¦å®š (è–ªè³‡ä½æ–¼1.5å€åŸºæœ¬å·¥è³‡æ‰£6%ï¼Œè¶…éæ‰£18%ï¼›åŸ·è¡Œæ¥­å‹™æ‰£20%)ã€‚
                </div>

                <div class="signature-row">
                    <div class="sig-box">
                        <strong>æ ¸æ±ºä¸»ç®¡ï¼š</strong>
                        <br><br><br>
                        <div style="border-bottom:1px solid #000; width:100%;"></div>
                    </div>
                    <div class="sig-box">
                        <strong>æ‰€å¾—äººç°½ç« ï¼š</strong>
                        <br><br><br>
                        <div style="border-bottom:1px solid #000; width:100%;"></div>
                        <div style="text-align:right; margin-top:5px; font-size:11pt;">
                            ç°½æ”¶æ—¥æœŸï¼š____/____/____
                        </div>
                    </div>
                </div>

                <div class="id-paste-area">
                    <div class="paste-box" onclick="document.getElementById('file_front').click()">
                        <span id="text_front" class="paste-text">èº«åˆ†è­‰ (æ­£é¢)<br>é»è²¼è™•<br><small>(é»æ­¤é¸æ“‡æª”æ¡ˆ)</small></span>
                        <img id="img_front" alt="æ­£é¢">
                    </div>
                    <div class="paste-box" onclick="document.getElementById('file_back').click()">
                        <span id="text_back" class="paste-text">èº«åˆ†è­‰ (åé¢)<br>é»è²¼è™•<br><small>(é»æ­¤é¸æ“‡æª”æ¡ˆ)</small></span>
                        <img id="img_back" alt="åé¢">
                    </div>
                </div>

                <div class="page-break"></div>
                <div class="header" style="margin-top:40px;">
                    <div class="doc-title" style="border:none;">é™„ä»¶è³‡æ–™</div>
                </div>
                <div class="bankbook-page">
                    å­˜æ‘ºå°é¢å½±æœ¬<br>é»è²¼è™•
                </div>
            </div>
        </div>
    </div>

    <div id="tab-history" class="tab-pane">
        <div class="history-container">
            <h2 style="color:#2c3e50; border-bottom:2px solid #eee; padding-bottom:10px;">ğŸ“‚ æ­·å²å­˜æª”ç´€éŒ„</h2>
            <div style="text-align:right; margin-bottom:10px; font-size:14px; color:#777;">
                * åƒ…å„²å­˜æ–‡å­—è³‡æ–™ï¼Œåœ–ç‰‡éœ€æ¯æ¬¡é‡æ–°ä¸Šå‚³
            </div>
            
            <table class="history-table">
                <thead>
                    <tr>
                        <th>æ—¥æœŸ</th>
                        <th>æ‰€å¾—äººå§“å</th>
                        <th>æ‰€å¾—é¡åˆ¥</th>
                        <th>çµ¦ä»˜ç¸½é¡</th>
                        <th>æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="historyBody"></tbody>
            </table>
            <div id="no-history-msg" style="text-align:center; padding:20px; color:#aaa; display:none;">
                ç›®å‰æ²’æœ‰ä»»ä½•å­˜æª”ç´€éŒ„
            </div>
        </div>
    </div>

</div>

<script>
    let isResident = true;

    function init() {
        document.getElementById('in_date').valueAsDate = new Date();
        loadConfig();
        loadHistory();
        refreshPreview();
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + tabName).classList.add('active');
        const tabs = ['edit', 'preview', 'history'];
        const idx = tabs.indexOf(tabName);
        document.querySelectorAll('.nav-item')[idx].classList.add('active');
        if(tabName === 'history') loadHistory();
        if(tabName === 'preview') refreshPreview();
        document.querySelector('.tab-content').scrollTop = 0;
    }

    // --- æµ®æ°´å°è™•ç† (é›™è¡Œé å·¦) ---
    function processImage(input, imgId, textId, type) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const reader = new FileReader();
            const company = document.getElementById('cfg_company').value || "æœ¬å…¬å¸";
            
            // å¼·åˆ¶å…©è¡Œæ–‡å­—
            const line1 = `åƒ…ä¾› ${company}`;
            const line2 = `ç”³è«‹å‹å‹™å ±é…¬ä½¿ç”¨`;

            reader.onload = function(e) {
                const img = new Image();
                img.src = e.target.result;
                img.onload = function() {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width;
                    canvas.height = img.height;

                    // 1. ç¹ªè£½åŸåœ–
                    ctx.drawImage(img, 0, 0);

                    // 2. è¨­å®šæ¨£å¼ (å­—é«”æ”¾å¤§)
                    const fontSize = canvas.width * 0.055; 
                    ctx.font = `bold ${fontSize}px "Microsoft JhengHei"`;
                    ctx.fillStyle = "rgba(255, 255, 255, 0.9)"; // å¹¾ä¹ä¸é€æ˜çš„ç™½
                    ctx.textAlign = "left"; // é å·¦å°é½Š
                    ctx.textBaseline = "middle";
                    ctx.shadowColor = "rgba(0, 0, 0, 0.6)"; // æ·±è‰²é™°å½±
                    ctx.shadowBlur = 4;

                    // 3. å®šä½
                    // x è»¸ï¼šå¾å·¦å´ 5% è™•é–‹å§‹
                    let x = canvas.width * 0.05;
                    // y è»¸ï¼šæ­£é¢ç´„ 25%ï¼Œåé¢ç´„ 80%
                    let y = type === 'front' ? canvas.height * 0.25 : canvas.height * 0.80;
                    const lineHeight = fontSize * 1.3;

                    // 4. ç¹ªè£½å…©è¡Œ
                    ctx.fillText(line1, x, y);
                    ctx.fillText(line2, x, y + lineHeight);

                    // 5. è¼¸å‡º
                    document.getElementById(imgId).src = canvas.toDataURL('image/jpeg');
                    document.getElementById(imgId).style.display = 'block';
                    document.getElementById(textId).style.display = 'none';
                };
            }
            reader.readAsDataURL(file);
        }
    }

    function clearImage(imgId, textId, inputId) {
        document.getElementById(imgId).src = "";
        document.getElementById(imgId).style.display = 'none';
        document.getElementById(textId).style.display = 'block';
        document.getElementById(inputId).value = ""; 
    }

    function saveConfig() {
        const config = {
            year: document.getElementById('cfg_year').value,
            company: document.getElementById('cfg_company').value,
            minWage: document.getElementById('cfg_minWage').value,
            taxThresh: document.getElementById('cfg_taxThresh').value,
            nhiRate: document.getElementById('cfg_nhiRate').value,
            taxRate: document.getElementById('cfg_taxRate').value
        };
        localStorage.setItem('salary_sys_config_v2', JSON.stringify(config));
    }

    function loadConfig() {
        const saved = localStorage.getItem('salary_sys_config_v2');
        if(saved) {
            const config = JSON.parse(saved);
            document.getElementById('cfg_year').value = config.year;
            document.getElementById('cfg_company').value = config.company;
            document.getElementById('cfg_minWage').value = config.minWage;
            document.getElementById('cfg_taxThresh').value = config.taxThresh;
            document.getElementById('cfg_nhiRate').value = config.nhiRate;
            document.getElementById('cfg_taxRate').value = config.taxRate;
        }
    }

    function fmt(num) {
        if(isNaN(num)) return "0";
        return num.toLocaleString('en-US');
    }
    function getRawVal(id) {
        const val = document.getElementById(id).value;
        return parseFloat(val.replace(/,/g, '')) || 0;
    }
    function unfmtField(el) {
        const val = parseFloat(el.value.replace(/,/g, ''));
        if (!isNaN(val)) el.value = val;
    }
    function fmtField(el) {
        const val = parseFloat(el.value);
        if (!isNaN(val)) el.value = fmt(val);
    }

    function setResidency(val) {
        isResident = val;
        document.getElementById('btn_res').className = val ? 'toggle-opt active' : 'toggle-opt';
        document.getElementById('btn_non').className = !val ? 'toggle-opt active' : 'toggle-opt';
        refreshPreview();
    }
    function toggleUnionCheck() {
        const chk = document.getElementById('chk_union');
        chk.checked = !chk.checked;
        refreshPreview();
    }

    function refreshPreview() {
        const year = document.getElementById('cfg_year').value;
        const company = document.getElementById('cfg_company').value;
        const minWage = getRawVal('cfg_minWage');
        const taxThresh = getRawVal('cfg_taxThresh');
        const nhiRate = parseFloat(document.getElementById('cfg_nhiRate').value) / 100;
        const taxRate = parseFloat(document.getElementById('cfg_taxRate').value) / 100;

        const total = parseFloat(document.getElementById('in_total').value) || 0;
        const type = document.getElementById('in_type').value;
        const isUnion = document.getElementById('chk_union').checked;

        let tax = 0;
        let nhi = 0;
        let taxFormula = "";
        let nhiFormula = "";

        if (isUnion || !isResident) {
            nhi = 0;
        } else {
            if (type === '50') {
                if (total >= minWage) {
                    nhi = Math.round(total * nhiRate);
                    nhiFormula = `$${fmt(total)} Ã— ${(nhiRate*100).toFixed(2)}%`;
                }
            } else {
                if (total >= 20000) {
                    nhi = Math.round(total * nhiRate);
                    nhiFormula = `$${fmt(total)} Ã— ${(nhiRate*100).toFixed(2)}%`;
                }
            }
        }

        if (isResident) {
            if (type === '50') {
                if (total >= taxThresh) {
                    tax = Math.floor(total * taxRate);
                    taxFormula = `$${fmt(total)} Ã— ${(taxRate*100)}%`;
                }
            } else {
                if (total >= 20000) {
                    tax = Math.floor(total * 0.1); 
                    taxFormula = `$${fmt(total)} Ã— 10%`;
                }
            }
        } else {
            if (type === '50') {
                const limit = minWage * 1.5;
                if (total <= limit) {
                    tax = Math.floor(total * 0.06);
                    taxFormula = `$${fmt(total)} Ã— 6%`;
                } else {
                    tax = Math.floor(total * 0.18);
                    taxFormula = `$${fmt(total)} Ã— 18%`;
                }
            } else {
                tax = Math.floor(total * 0.20);
                taxFormula = `$${fmt(total)} Ã— 20%`;
            }
        }

        const net = total - tax - nhi;

        document.getElementById('out_company').innerText = company;
        document.getElementById('out_date').innerText = document.getElementById('in_date').value;
        document.getElementById('out_name').innerText = document.getElementById('in_name').value;
        document.getElementById('out_id').innerText = document.getElementById('in_id').value;
        document.getElementById('out_content').innerText = document.getElementById('in_content').value;
        
        document.getElementById('out_total').innerText = fmt(total);
        document.getElementById('out_tax').innerText = fmt(tax);
        document.getElementById('out_nhi').innerText = fmt(nhi);
        document.getElementById('out_net').innerText = `æ–°å°å¹£ ${fmt(net)} å…ƒæ•´`;

        const taxLabel = document.getElementById('out_tax_label');
        taxLabel.innerHTML = tax > 0 ? `ä»£æ‰£æ‰€å¾—ç¨… <span class="calc-formula">(${taxFormula})</span>` : `ä»£æ‰£æ‰€å¾—ç¨…`;

        const nhiLabel = document.getElementById('out_nhi_label');
        nhiLabel.innerHTML = nhi > 0 ? `ä»£æ‰£äºŒä»£å¥ä¿è£œå……ä¿è²» <span class="calc-formula">(${nhiFormula})</span>` : `ä»£æ‰£äºŒä»£å¥ä¿è£œå……ä¿è²»`;

        document.getElementById('out_res').innerText = isResident ? "å±…ä½è€…" : "éå±…ä½è€…";
        document.getElementById('out_union').innerText = isUnion ? "æ˜¯" : "å¦";

        const types = {'50':'50 - è–ªè³‡æ‰€å¾—', '9A':'9A - åŸ·è¡Œæ¥­å‹™', '9B':'9B - ç¨¿è²»/æ¼”è¬›'};
        document.getElementById('out_type').innerText = types[type];

        document.getElementById('note_year').innerText = year;
        document.getElementById('note_tax_thresh').innerText = fmt(taxThresh);
        document.getElementById('note_min_wage').innerText = fmt(minWage);
        document.getElementById('note_tax_rate').innerText = (taxRate*100);
        document.getElementById('note_nhi_rate').innerText = (nhiRate*100).toFixed(2);
        document.getElementById('note_nhi_rate_2').innerText = (nhiRate*100).toFixed(2);
    }

    function saveRecord() {
        const name = document.getElementById('in_name').value;
        const total = document.getElementById('in_total').value;
        if(!name) { alert('è«‹è‡³å°‘è¼¸å…¥æ‰€å¾—äººå§“å'); return; }

        const record = {
            id: Date.now(),
            date: document.getElementById('in_date').value,
            name: name,
            idNo: document.getElementById('in_id').value,
            type: document.getElementById('in_type').value,
            content: document.getElementById('in_content').value,
            total: total,
            isRes: isResident,
            isUnion: document.getElementById('chk_union').checked
        };

        let history = JSON.parse(localStorage.getItem('salary_records_v2') || '[]');
        history.unshift(record);
        localStorage.setItem('salary_records_v2', JSON.stringify(history));
        
        alert('âœ… å­˜æª”æˆåŠŸï¼(åœ–ç‰‡ä¸æœƒå„²å­˜)');
        loadHistory();
    }

    function loadHistory() {
        const tbody = document.getElementById('historyBody');
        const history = JSON.parse(localStorage.getItem('salary_records_v2') || '[]');
        const noMsg = document.getElementById('no-history-msg');

        tbody.innerHTML = '';
        if(history.length === 0) {
            noMsg.style.display = 'block';
            return;
        }
        noMsg.style.display = 'none';

        const types = {'50':'è–ªè³‡', '9A':'åŸ·è¡Œæ¥­å‹™', '9B':'ç¨¿è²»'};

        history.forEach(item => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${item.date || '-'}</td>
                <td style="font-weight:bold;">${item.name}</td>
                <td>${types[item.type] || item.type}</td>
                <td style="font-family:monospace;">$${fmt(parseInt(item.total))}</td>
                <td>
                    <button class="btn-sm btn-load" onclick="loadItem(${item.id})">è¼‰å…¥</button>
                    <button class="btn-sm btn-del" onclick="delItem(${item.id})">åˆªé™¤</button>
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function loadItem(id) {
        const history = JSON.parse(localStorage.getItem('salary_records_v2') || '[]');
        const item = history.find(h => h.id === id);
        if(item) {
            document.getElementById('in_date').value = item.date;
            document.getElementById('in_name').value = item.name;
            document.getElementById('in_id').value = item.idNo;
            document.getElementById('in_type').value = item.type;
            document.getElementById('in_content').value = item.content || '';
            document.getElementById('in_total').value = item.total;
            setResidency(item.isRes);
            document.getElementById('chk_union').checked = item.isUnion;
            alert('å·²è¼‰å…¥æ–‡å­—è³‡æ–™ï¼Œè«‹é‡æ–°ä¸Šå‚³èº«åˆ†è­‰åœ–ç‰‡ã€‚');
            switchTab('edit'); 
        }
    }

    function delItem(id) {
        if(!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ')) return;
        let history = JSON.parse(localStorage.getItem('salary_records_v2') || '[]');
        history = history.filter(h => h.id !== id);
        localStorage.setItem('salary_records_v2', JSON.stringify(history));
        loadHistory();
    }

    function clearForm() {
        if(!confirm('ç¢ºå®šæ¸…ç©ºæ‰€æœ‰æ¬„ä½ï¼Ÿ')) return;
        document.getElementById('in_name').value = '';
        document.getElementById('in_id').value = '';
        document.getElementById('in_content').value = '';
        document.getElementById('in_total').value = '';
        clearImage('img_front', 'text_front', 'file_front');
        clearImage('img_back', 'text_back', 'file_back');
        refreshPreview();
        document.querySelector('.tab-content').scrollTop = 0;
    }

    window.onload = init;
</script>

</body>
</html>
